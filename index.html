<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Need these! -->
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
    <!-- -->

    <style>
        /* This should probably go */
        body { margin:0; padding:0; }

        /* This one needs to be changed as appropriate for responsiveness */
        #map { position:absolute; top:0; bottom:0; width:100%; }

        /* From here downwards should be tweaked for MKW branding */
        .mapboxgl-popup-content {
            max-width: 400px;
        }
        .mapboxgl-popup-content img {
            max-width: 80%;
        }

        .mapboxgl-popup-content .moreinfo {
            display: block;
            height:30px;
            background:#00aecb;
            color:white;
        }
    </style>


</head>
<body>

<div id='map'></div>
<script>

function def(a, b) {
    return a !== undefined ? a : b;
}


var mkwEvents = {};

function eventsToGeoJson(events) {
    var mapData = {
        type:'FeatureCollection',
        features: []
    };
    events.forEach(function(event) {
        var long = Number(event.longitude);
        var lat = Number(event.latitude);
        var k3 = Math.random()
        mapData.features.push({
            type: 'Feature',
            properties: event.sensor_id,
            geometry: {
                type: 'LineString',

                // ### TODO: use actual coordinates
                coordinates: [
                    [long - 0.0001, lat],
                    [long, lat + k3 * 0.02],
                    [long + 0.0001, lat]
                ]
            }
        });
    });
    console.log(mapData);
    return mapData;
}

function dumpAddressesCsv(acfs) {
    var rows=[];
    acfs.forEach(function(acf) {
        var e = acf.acf;
        rows.push({
            id: acf.id,
            address: [e.location_address.street1, e.location_address.street2, e.location_address.city, e.location_address.state, e.location_address.zip, 'Australia'].join(' ')
        });
        
    });
    // console.log(d3.csvFormat(rows));
}

var metadataCount = 0;

function metadataLoaded(data) {

    var mapData = eventsToGeoJson(data);
    console.log(mapData);

    whenMapLoaded(function() {

        if (map.getSource('mkw-events')) 
            map.removeSource('mkw-events');


        map.addSource('mkw-events', {
            type: 'geojson',
            data: mapData
        });

        if (map.getLayer('mkw-event-line')) 
            map.removeLayer('mkw-event-line');

        map.addLayer({
            id: 'mkw-event-line',
            source: 'mkw-events',
            type: 'line',
            layout: {
                'line-cap': 'round',
                'line-join': 'round'            
            }, 
            paint: {
                'line-color': '#ed6498',
                'line-width': 2.5,
                'line-opacity': 0.8
            }
        });

        // When we click on a pin, show a popup.
        /* map.on('click', 'mkw-event-line', function (e) {
            var event = e.features[0];
            new mapboxgl.Popup()
                .setLngLat(event.geometry.coordinates)
                .setHTML(
                    '<img src="' + event.properties.hero_image + '">' +
                    '<h2>' + event.properties.title + '</h2>' + 
                    event.properties.excerpt + 
                    '<label class="dates">' + event.properties.program_date + ', ' + event.properties.event_dates_start + ' - ' +  event.properties.event_dates_end + '</label>' +
                    '<a class="moreinfo" href="' + event.properties.link + '">More information</a>'
                ).addTo(map);
        });

        map.on('mouseenter', 'mkw-event-line', function () {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'mkw-event-line', function () {
            map.getCanvas().style.cursor = '';
        }); */
    });
}

function whenMapLoaded(f) {
    return map.loaded() ? f() : map.once('load', f);
}

function onLoad() {

    d3.csv('sensor.csv', function(d) {
        console.log(d);
        var k = 0;
        var iter = setInterval(function(){
            if (k == 30) {
                clearInterval(iter);
            }
            else {
                metadataLoaded(d);
                k++;
            }
        }, 300)
        metadataLoaded(d);
    })


}

mapboxgl.accessToken = 'pk.eyJ1IjoiY2l0eW9mbWVsYm91cm5lIiwiYSI6ImNpejdob2J0czAwOWQzM21ubGt6MDVqaHoifQ.55YbqeTHWMK_b6CEAmoUlA';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/cityofmelbourne/cj1pz0q5d00382rp7zylkhxp1?update=1',
    center: [144.9, -37.8],
    zoom: 12
});
onLoad();
</script>

</body>
</html>